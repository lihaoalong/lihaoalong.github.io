<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自建服务与个人博客 - 真正自动同步版</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .sync-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .sync-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .sync-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .sync-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .blog-post, .link-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #667eea;
        }

        .blog-post:hover, .link-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-title, .item-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .item-category {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .item-date {
            color: #888;
        }

        .item-content {
            color: #555;
            line-height: 1.6;
        }

        .item-url {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
            display: block;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .item-url:hover {
            text-decoration: underline;
        }

        .item-remark {
            color: #666;
            font-style: italic;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .btn-edit, .btn-delete, .btn-sync {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-edit {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .btn-sync {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
            font-style: italic;
        }

        .divider {
            margin: 30px 0;
            border: none;
            height: 1px;
            background: linear-gradient(to right, transparent, #ccc, transparent);
        }

        .auto-sync-note {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>自建服务与个人博客 - 真正自动同步版</h1>
            <p>在线编辑，自动同步到所有设备</p>
        </header>

        <div class="auto-sync-note">
            <strong>提示：</strong>每次添加、编辑或删除数据后，系统会自动同步到云端，其他设备访问时会自动获取最新数据。
        </div>

        <div class="sync-section">
            <h2>同步状态</h2>
            <div class="sync-controls">
                <button class="btn-sync" onclick="realAutoSyncManager.syncFromCloud()">从云端同步</button>
                <button class="btn-sync" onclick="realAutoSyncManager.saveToCloud()">保存到云端</button>
                <span id="lastSyncTime">上次同步: 从未同步</span>
            </div>
            <div id="syncStatus" class="sync-status"></div>
        </div>

        <!-- 博客备忘录部分 -->
        <div class="sync-section">
            <h2>个人博客备忘录</h2>
            <form id="blogForm">
                <div class="form-group">
                    <label for="blogTitle">标题:</label>
                    <input type="text" id="blogTitle" required placeholder="输入博客标题">
                </div>
                <div class="form-group">
                    <label for="blogContent">内容:</label>
                    <textarea id="blogContent" required placeholder="输入备忘录内容..."></textarea>
                </div>
                <div class="form-group">
                    <label for="blogCategory">分类:</label>
                    <select id="blogCategory">
                        <option value="工作">工作</option>
                        <option value="生活">生活</option>
                        <option value="技术">技术</option>
                        <option value="学习">学习</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <button type="submit">发布备忘录</button>
            </form>

            <div id="blogPostsContainer">
                <!-- 博客文章将通过JavaScript动态添加 -->
            </div>
        </div>

        <!-- 分隔线 -->
        <hr class="divider">

        <!-- 链接管理部分 -->
        <div class="sync-section">
            <h2>自建服务链接管理</h2>
            <form id="linkForm">
                <div class="form-group">
                    <label for="linkName">链接名称:</label>
                    <input type="text" id="linkName" required placeholder="例如：xui 节点">
                </div>
                <div class="form-group">
                    <label for="linkUrl">链接地址:</label>
                    <input type="url" id="linkUrl" required placeholder="例如：https://example.com">
                </div>
                <div class="form-group">
                    <label for="linkRemark">备注:</label>
                    <textarea id="linkRemark" placeholder="可选备注信息"></textarea>
                </div>
                <button type="submit">添加链接</button>
            </form>

            <div id="linksContainer">
                <!-- 链接将通过JavaScript动态添加 -->
            </div>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHgwI90dvKi7dCeYG-t5_caY2pHBLvscQ",
            authDomain: "blog-sync-c35d9.firebaseapp.com",
            databaseURL: "https://blog-sync-c35d9-default-rtdb.firebaseio.com",
            projectId: "blog-sync-c35d9",
            storageBucket: "blog-sync-c35d9.firebasestorage.app",
            messagingSenderId: "720901204000",
            appId: "1:720901204000:web:1fcd93bcad1f2c04b03445",
            measurementId: "G-JQGEC84TJE"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 真正自动同步管理器
        class RealAutoSyncManager {
            constructor() {
                this.links = this.loadLinks();
                this.blogPosts = this.loadBlogPosts();
                // 使用浏览器存储的同步令牌，确保跨设备识别
                this.syncToken = localStorage.getItem('syncToken') || this.generateSyncToken();
                if (!localStorage.getItem('syncToken')) {
                    localStorage.setItem('syncToken', this.syncToken);
                }
                
                this.lastSyncTime = localStorage.getItem('lastSyncTime') || 0;
                this.init();
            }

            init() {
                this.renderLinks();
                this.renderBlogPosts();
                this.updateLastSyncTime();
                this.bindEvents();
                
                // 页面加载时自动同步最新数据
                this.autoSync();
            }

            // 生成同步令牌
            generateSyncToken() {
                return 'sync_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // 加载本地存储的链接
            loadLinks() {
                const savedLinks = localStorage.getItem('serviceLinks');
                return savedLinks ? JSON.parse(savedLinks) : this.getDefaultLinks();
            }

            // 加载本地存储的博客文章
            loadBlogPosts() {
                const savedPosts = localStorage.getItem('blogPosts');
                return savedPosts ? JSON.parse(savedPosts) : [];
            }

            // 获取默认链接
            getDefaultLinks() {
                return [
                    { id: 1, name: 'xui 节点', url: 'https://152.69.231.38:54322/09f/xui/', remark: 'xui节点地址1' },
                    { id: 2, name: 'xui 节点', url: 'https://lihaoalong.top:54322/09f/xui/', remark: 'xui节点地址2' },
                    { id: 3, name: 'xui 节点', url: 'https://158.180.82.83:54322/09f/xui/', remark: 'xui节点地址3' },
                    { id: 4, name: '1panel面板', url: 'http://158.180.82.83:24882/alonglihao', remark: '1panel面板地址1' },
                    { id: 5, name: '1panel面板', url: 'http://152.69.231.38:28560/alonglihao', remark: '1panel面板地址2' },
                    { id: 6, name: 'Cloudflare', url: 'https://dash.cloudflare.com/0d4e7ec8269b1df4288f7e6430e534d3/lihaoalong.asia', remark: 'Cloudflare管理面板' },
                    { id: 7, name: '优选IP', url: 'https://lihaoalong.dpdns.org/ADMIN', remark: '优选IP管理' },
                    { id: 8, name: '饭太硬TV', url: 'http://www.饭太硬.com/tv', remark: '饭太硬TV源' },
                    { id: 9, name: 'OK影视', url: 'http://ok321.top/tv', remark: 'OK影视TV源' }
                ];
            }

            // 保存链接到本地存储
            saveLinks() {
                localStorage.setItem('serviceLinks', JSON.stringify(this.links));
            }

            // 保存博客文章到本地存储
            saveBlogPosts() {
                localStorage.setItem('blogPosts', JSON.stringify(this.blogPosts));
            }

            // 绑定事件
            bindEvents() {
                // 博客表单提交事件
                const blogForm = document.getElementById('blogForm');
                blogForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addBlogPost();
                });

                // 链接表单提交事件
                const linkForm = document.getElementById('linkForm');
                linkForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addLink();
                });
            }

            // 自动同步 - 检查是否有更新的数据
            async autoSync() {
                try {
                    // 尝试从云端获取最新数据
                    const cloudData = await this.fetchFromCloud();
                    if (cloudData && cloudData.timestamp > this.lastSyncTime) {
                        // 云端数据更新，同步到本地
                        this.links = cloudData.links || this.links;
                        this.blogPosts = cloudData.blogPosts || this.blogPosts;
                        this.saveLinks();
                        this.saveBlogPosts();
                        this.renderLinks();
                        this.renderBlogPosts();
                        this.lastSyncTime = cloudData.timestamp;
                        localStorage.setItem('lastSyncTime', this.lastSyncTime);
                        this.updateLastSyncTime();
                        this.showStatus('已同步云端最新数据', 'success');
                    }
                } catch (error) {
                    // 如果云端同步失败，继续使用本地数据
                    console.log('自动同步失败，使用本地数据');
                }
            }

            // 从云端同步数据
            async syncFromCloud() {
                this.showStatus('正在从云端加载数据...', 'loading');
                
                try {
                    const cloudData = await this.fetchFromCloud();
                    if (cloudData) {
                        this.links = cloudData.links || this.links;
                        this.blogPosts = cloudData.blogPosts || this.blogPosts;
                        this.saveLinks();
                        this.saveBlogPosts();
                        this.renderLinks();
                        this.renderBlogPosts();
                        this.lastSyncTime = cloudData.timestamp;
                        localStorage.setItem('lastSyncTime', this.lastSyncTime);
                        this.updateLastSyncTime();
                        this.showStatus('数据同步成功！', 'success');
                    } else {
                        this.showStatus('云端暂无数据', 'error');
                    }
                } catch (error) {
                    this.showStatus('同步失败: ' + error.message, 'error');
                }
            }

            // 保存数据到Firebase
            async saveToCloud() {
                this.showStatus('正在保存到云端...', 'loading');
                
                const data = {
                    links: this.links,
                    blogPosts: this.blogPosts,
                    timestamp: Date.now()
                };
                
                try {
                    await database.ref('users/' + this.syncToken).set(data);
                    this.lastSyncTime = Date.now();
                    localStorage.setItem('lastSyncTime', this.lastSyncTime);
                    this.updateLastSyncTime();
                    this.showStatus('数据已保存到云端！', 'success');
                } catch (error) {
                    console.error('保存到Firebase失败:', error);
                    this.showStatus('保存失败: ' + error.message, 'error');
                }
            }

            // 从Firebase获取数据
            async fetchFromCloud() {
                try {
                    const snapshot = await database.ref('users/' + this.syncToken).once('value');
                    return snapshot.val();
                } catch (error) {
                    console.error('从Firebase获取数据失败:', error);
                    return null;
                }
            }

            // 显示状态消息
            showStatus(message, type) {
                const statusElement = document.getElementById('syncStatus');
                statusElement.textContent = message;
                statusElement.className = `sync-status status-${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }

            // 更新最后同步时间显示
            updateLastSyncTime() {
                const lastSyncElement = document.getElementById('lastSyncTime');
                if (this.lastSyncTime > 0) {
                    const date = new Date(parseInt(this.lastSyncTime));
                    lastSyncElement.textContent = `上次同步: ${date.toLocaleString('zh-CN')}`;
                } else {
                    lastSyncElement.textContent = '上次同步: 从未同步';
                }
            }

            // 渲染链接列表
            renderLinks() {
                const container = document.getElementById('linksContainer');
                
                if (this.links.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>暂无链接</h3>
                            <p>添加一些服务链接以便管理</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.links.map(link => `
                    <div class="link-item" data-id="${link.id}">
                        <div class="item-header">
                            <div class="item-name">${this.escapeHtml(link.name)}</div>
                        </div>
                        <a href="${this.escapeHtml(link.url)}" target="_blank" class="item-url">${this.escapeHtml(link.url)}</a>
                        ${link.remark ? `<div class="item-remark">${this.escapeHtml(link.remark)}</div>` : ''}
                        <div class="item-actions">
                            <button class="btn-edit" onclick="realAutoSyncManager.editLink(${link.id})">编辑</button>
                            <button class="btn-delete" onclick="realAutoSyncManager.deleteLink(${link.id})">删除</button>
                        </div>
                    </div>
                `).join('');
            }

            // 渲染博客文章列表
            renderBlogPosts() {
                const container = document.getElementById('blogPostsContainer');
                
                if (this.blogPosts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>暂无备忘录</h3>
                            <p>发布一些备忘录记录重要信息</p>
                        </div>
                    `;
                    return;
                }

                // 按时间倒序排列（最新的在前）
                const sortedPosts = [...this.blogPosts].sort((a, b) => b.timestamp - a.timestamp);

                container.innerHTML = sortedPosts.map(post => `
                    <div class="blog-post" data-id="${post.id}">
                        <div class="item-header">
                            <div class="item-title">${this.escapeHtml(post.title)}</div>
                        </div>
                        <div class="item-meta">
                            <span class="item-category">${this.escapeHtml(post.category)}</span>
                            <span class="item-date">${new Date(post.timestamp).toLocaleString('zh-CN')}</span>
                        </div>
                        <div class="item-content">${this.escapeHtml(post.content).replace(/\n/g, '<br>')}</div>
                        <div class="item-actions">
                            <button class="btn-edit" onclick="realAutoSyncManager.editBlogPost(${post.id})">编辑</button>
                            <button class="btn-delete" onclick="realAutoSyncManager.deleteBlogPost(${post.id})">删除</button>
                        </div>
                    </div>
                `).join('');
            }

            // 转义HTML以防止XSS
            escapeHtml(text) {
                if (typeof text !== 'string') {
                    return text;
                }
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            // 添加博客文章 - 重写以实现自动同步
            async addBlogPost() {
                const titleInput = document.getElementById('blogTitle');
                const contentInput = document.getElementById('blogContent');
                const categoryInput = document.getElementById('blogCategory');

                const title = titleInput.value.trim();
                const content = contentInput.value.trim();
                const category = categoryInput.value;

                if (!title || !content) {
                    alert('请填写标题和内容');
                    return;
                }

                const newPost = {
                    id: Date.now(), // 使用时间戳作为唯一ID
                    title: title,
                    content: content,
                    category: category,
                    timestamp: Date.now()
                };

                this.blogPosts.push(newPost);
                this.saveBlogPosts();
                this.renderBlogPosts();

                // 重置表单
                titleInput.value = '';
                contentInput.value = '';
                categoryInput.value = '工作';
                
                // 自动保存到云端
                await this.saveToCloud();
            }

            // 添加新链接 - 重写以实现自动同步
            async addLink() {
                const nameInput = document.getElementById('linkName');
                const urlInput = document.getElementById('linkUrl');
                const remarkInput = document.getElementById('linkRemark');

                const name = nameInput.value.trim();
                const url = urlInput.value.trim();
                const remark = remarkInput.value.trim();

                if (!name || !url) {
                    alert('请填写链接名称和地址');
                    return;
                }

                // 验证URL格式
                try {
                    new URL(url);
                } catch (e) {
                    alert('请输入有效的链接地址');
                    return;
                }

                const newLink = {
                    id: Date.now(), // 使用时间戳作为唯一ID
                    name: name,
                    url: url,
                    remark: remark
                };

                this.links.push(newLink);
                this.saveLinks();
                this.renderLinks();

                // 重置表单
                nameInput.value = '';
                urlInput.value = '';
                remarkInput.value = '';
                
                // 自动保存到云端
                await this.saveToCloud();
            }

            // 删除博客文章 - 重写以实现自动同步
            async deleteBlogPost(id) {
                if (confirm('确定要删除这篇备忘录吗？')) {
                    this.blogPosts = this.blogPosts.filter(post => post.id !== id);
                    this.saveBlogPosts();
                    this.renderBlogPosts();
                    await this.saveToCloud();
                }
            }

            // 删除链接 - 重写以实现自动同步
            async deleteLink(id) {
                if (confirm('确定要删除这个链接吗？')) {
                    this.links = this.links.filter(link => link.id !== id);
                    this.saveLinks();
                    this.renderLinks();
                    await this.saveToCloud();
                }
            }

            // 编辑博客文章 - 重写以实现自动同步
            async editBlogPost(id) {
                const post = this.blogPosts.find(p => p.id === id);
                if (!post) return;

                const newContent = prompt('编辑内容:', post.content);
                if (newContent !== null) {
                    post.content = newContent;
                    this.saveBlogPosts();
                    this.renderBlogPosts();
                    await this.saveToCloud();
                }
            }

            // 编辑链接 - 重写以实现自动同步
            async editLink(id) {
                const link = this.links.find(l => l.id === id);
                if (!link) return;

                const newName = prompt('编辑名称:', link.name) || link.name;
                const newUrl = prompt('编辑链接:', link.url) || link.url;
                const newRemark = prompt('编辑备注:', link.remark) || link.remark;

                if (newName && newUrl) {
                    try {
                        new URL(newUrl);
                        link.name = newName;
                        link.url = newUrl;
                        link.remark = newRemark;
                        this.saveLinks();
                        this.renderLinks();
                        await this.saveToCloud();
                    } catch (e) {
                        alert('请输入有效的链接地址');
                    }
                }
            }
        }

        // 初始化应用
        let realAutoSyncManager;
        document.addEventListener('DOMContentLoaded', () => {
            realAutoSyncManager = new RealAutoSyncManager();
        });
    </script>
</body>
</html>